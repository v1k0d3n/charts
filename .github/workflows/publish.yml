name: Publish Helm Charts

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.0

    - name: Initialize repository
      run: make init

    - name: Update charts
      run: make update-charts

    - name: Update repository index
      run: make index

    - name: Verify charts directory
      run: |
        echo "Checking charts directory structure..."
        ls -la charts/ || echo "Charts directory is empty or doesn't exist"
        if [ -f "charts/index.yaml" ]; then
          echo "Repository index found"
          cat charts/index.yaml
        else
          echo "No repository index found - creating empty one"
          mkdir -p charts
          helm repo index charts --url https://v1k0d3n.github.io/charts
        fi

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './charts'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add charts/
        git diff --quiet && git diff --staged --quiet || git commit -m "Update charts [skip ci]"
        git push
